SPEAKER_PIN EQU P2.1
BEEP_TONE    EQU 180
BEEP_LENGTH  EQU 80
BEEP_SPACE   EQU 80

BEEP_STATE_CHANGE:
    MOV R7, #1
    LCALL DO_BEEPS
    RET

BEEP_COMPLETE:
    MOV R7, #5
    LCALL DO_BEEPS
    RET

BEEP_ERROR:
    MOV R7, #10
    LCALL DO_BEEPS
    RET

DO_BEEPS:
    PUSH ACC
    PUSH AR7
    
BEEP_NEXT:
    MOV A, R7
    JZ BEEP_ALL_DONE
    
    LCALL ONE_BEEP
    
    DEC R7
    MOV A, R7
    JZ BEEP_ALL_DONE
    
    LCALL BEEP_DELAY
    SJMP BEEP_NEXT
    
BEEP_ALL_DONE:
    POP AR7
    POP ACC
    RET

ONE_BEEP:
    PUSH ACC
    PUSH B
    
    MOV B, #BEEP_LENGTH
    
BEEP_SOUND:
    SETB SPEAKER_PIN
    MOV A, #BEEP_TONE
    LCALL MICRO_DELAY
    
    CLR SPEAKER_PIN
    MOV A, #BEEP_TONE
    LCALL MICRO_DELAY
    
    DJNZ B, BEEP_SOUND
    
    CLR SPEAKER_PIN
    
    POP B
    POP ACC
    RET

MICRO_DELAY:
    MOV R6, A
MICRO_LOOP:
    NOP
    NOP
    DJNZ R6, MICRO_LOOP
    RET

BEEP_DELAY:
    PUSH ACC
    PUSH AR6
    MOV R6, #BEEP_SPACE
DELAY_LOOP:
    MOV A, #BEEP_SPACE
    LCALL MICRO_DELAY
    DJNZ R6, DELAY_LOOP
    POP AR6
    POP ACC
    RET

ORG 0000H
    LJMP START

START:
    MOV R6, #250
INIT_DELAY:
    MOV A, #250
    LCALL MICRO_DELAY
    DJNZ R6, INIT_DELAY
    
    LCALL BEEP_STATE_CHANGE
    
    LCALL BEEP_DELAY
    LCALL BEEP_DELAY
    
    LCALL BEEP_COMPLETE
    
    LCALL BEEP_DELAY
    LCALL BEEP_DELAY
    
    LCALL BEEP_ERROR

HERE:
    SJMP HERE

END