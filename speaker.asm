SPEAKER_PIN EQU P1.0

BEEP_TONE    EQU 180
BEEP_LENGTH  EQU 80
BEEP_SPACE   EQU 80

BEEP_STATE_CHANGE:
    MOV R7, #1
    LCALL DO_BEEPS
    RET

BEEP_COMPLETE:
    MOV R7, #5
    LCALL DO_BEEPS
    RET

BEEP_ERROR:
    MOV R7, #10
    LCALL DO_BEEPS
    RET

DO_BEEPS:
    PUSH ACC
    
BEEP_NEXT:
    MOV A, R7
    JZ BEEP_ALL_DONE
    
    LCALL ONE_BEEP
    
    DEC R7
    MOV A, R7
    JZ BEEP_ALL_DONE
    LCALL BEEP_DELAY
    
    SJMP BEEP_NEXT
    
BEEP_ALL_DONE:
    POP ACC
    RET

ONE_BEEP:
    PUSH ACC
    PUSH B
    
    MOV B, #BEEP_LENGTH
    
BEEP_SOUND:
    SETB SPEAKER_PIN
    MOV A, #BEEP_TONE
    LCALL MICRO_DELAY
    
    CLR SPEAKER_PIN
    MOV A, #BEEP_TONE
    LCALL MICRO_DELAY
    
    DJNZ B, BEEP_SOUND
    
    CLR SPEAKER_PIN
    
    POP B
    POP ACC
    RET

MICRO_DELAY:
    PUSH ACC
MICRO_LOOP:
    NOP
    NOP
    DJNZ ACC, MICRO_LOOP
    POP ACC
    RET

BEEP_DELAY:
    PUSH ACC
    MOV A, #BEEP_SPACE
DELAY_LOOP:
    LCALL MICRO_DELAY
    DJNZ ACC, DELAY_LOOP
    POP ACC
    RET

END